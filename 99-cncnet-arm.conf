# CnCNet Server ARM Optimizations for AWS t4g.medium
# Place this file in /etc/sysctl.d/99-cncnet-arm.conf

# Network Stack Tuning for ARM Graviton2
# ========================================

# Core network settings
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.core.rmem_default = 16777216
net.core.wmem_default = 16777216
net.core.optmem_max = 65536

# Increase network device backlog (ARM handles this well)
net.core.netdev_max_backlog = 16384
net.core.netdev_budget = 600
net.core.netdev_budget_usecs = 8000

# Socket buffer sizes
net.core.somaxconn = 65535

# UDP specific tuning
net.ipv4.udp_mem = 16384 174760 134217728
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384

# TCP tuning (for HTTP/metrics endpoints)
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_notsent_lowat = 16384

# Enable TCP Fast Open
net.ipv4.tcp_fastopen = 3

# Connection tracking
net.netfilter.nf_conntrack_max = 262144
net.netfilter.nf_conntrack_buckets = 65536
net.netfilter.nf_conntrack_udp_timeout = 30
net.netfilter.nf_conntrack_udp_timeout_stream = 60

# IP settings
net.ipv4.ip_local_port_range = 1024 65535
net.ipv4.ip_forward = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# ICMP settings
net.ipv4.icmp_echo_ignore_all = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# SYN flood protection
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_syn_backlog = 8192

# Time wait buckets (important for game servers)
net.ipv4.tcp_max_tw_buckets = 2000000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15

# Keepalive settings
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 30

# ARM-specific: Better for Graviton2's memory subsystem
# ======================================================

# Virtual memory settings optimized for ARM
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 1500
vm.dirty_writeback_centisecs = 500

# Transparent Huge Pages (good for ARM)
vm.nr_hugepages = 0
kernel.shmmax = 68719476736
kernel.shmall = 4294967296

# File descriptor limits
fs.file-max = 2097152
fs.nr_open = 1048576

# Process scheduling (ARM-specific)
kernel.sched_migration_cost_ns = 5000000
kernel.sched_autogroup_enabled = 1

# CPU frequency governor settings (if available)
# Note: t4g instances usually handle this automatically
# cpupower frequency-set -g performance

# IRQ affinity for network interrupts (ARM optimization)
# This is handled better via irqbalance service
kernel.irqbalance = 1

# Security settings
kernel.randomize_va_space = 2
kernel.panic = 10
kernel.panic_on_oops = 1

# Core dumps
kernel.core_uses_pid = 1
kernel.core_pattern = /opt/cncnet/cores/core-%e-%s-%u-%g-%p-%t
fs.suid_dumpable = 0